<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="VitaTrack">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#4a90a4">
  <meta name="description" content="Track your meals and macros">
  <title>VitaTrack</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json">
  
  <!-- iOS icons -->
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg: #f8f9fa;
      --card: #ffffff;
      --primary: #4a90a4;
      --primary-dark: #3a7a8a;
      --text: #2d3436;
      --text-light: #636e72;
      --border: #dfe6e9;
      --success: #00b894;
      --danger: #d63031;
      --warning: #fdcb6e;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: 80px;
    }
    
    /* Header */
    header {
      background: var(--primary);
      color: white;
      padding: 16px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header h1 { font-size: 20px; font-weight: 600; }
    
    /* Navigation */
    nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card);
      display: flex;
      border-top: 1px solid var(--border);
      z-index: 100;
    }
    nav button {
      flex: 1;
      padding: 12px 8px;
      border: none;
      background: none;
      font-size: 12px;
      color: var(--text-light);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    nav button.active { color: var(--primary); }
    nav button svg { width: 24px; height: 24px; }
    
    /* Main content */
    main { padding: 16px; }
    .page { display: none; }
    .page.active { display: block; }
    
    /* Cards */
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .card h2 {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Form elements */
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 12px;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    label {
      display: block;
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 6px;
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:active { background: var(--primary-dark); }
    .btn-secondary {
      background: var(--bg);
      color: var(--text);
    }
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    /* Quick stats */
    .stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat {
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      text-align: center;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
    }
    .stat-label {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 4px;
    }
    
    /* Lists */
    .list-item {
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .list-item:last-child { border-bottom: none; }
    .list-item-title { font-weight: 500; }
    .list-item-subtitle { font-size: 13px; color: var(--text-light); margin-top: 2px; }
    .list-item-value { text-align: right; }
    .list-item-macro { font-size: 13px; color: var(--text-light); }
    .list-item-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    /* Ingredient chips */
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 12px 0;
    }
    .chip {
      background: var(--bg);
      padding: 8px 12px;
      border-radius: 16px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chip[onclick] {
      transition: background 0.2s;
    }
    .chip[onclick]:hover {
      background: var(--border);
    }
    .chip-remove {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--text-light);
      color: white;
      border: none;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
    }
    
    /* Search results */
    .search-results {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 12px;
    }
    .search-result {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .search-result:last-child { border-bottom: none; }
    .search-result:active { background: var(--bg); }
    .search-result-name { font-weight: 500; }
    .search-result-macros { font-size: 12px; color: var(--text-light); }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      align-items: flex-end;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--card);
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border-radius: 16px 16px 0 0;
      padding: 20px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .modal-header h3 { font-size: 18px; }
    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--bg);
      font-size: 20px;
      cursor: pointer;
    }
    
    /* Macros display */
    .macros-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 14px;
    }
    .macros-total {
      background: var(--bg);
      padding: 12px;
      border-radius: 8px;
      margin: 12px 0;
    }
    .macros-total .macros-row { font-weight: 600; }
    
    /* Empty state */
    .empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-light);
    }

    /* Skip day toggle */
    .skip-day-banner {
      background: var(--card);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .skip-day-banner .skip-info {
      flex: 1;
    }
    .skip-day-banner .skip-label {
      font-weight: 500;
      font-size: 15px;
    }
    .skip-day-banner .skip-sublabel {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 2px;
    }
    .toggle-track {
      width: 48px;
      height: 28px;
      border-radius: 14px;
      background: var(--border);
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    .toggle-track.active {
      background: var(--warning);
    }
    .toggle-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: white;
      position: absolute;
      top: 3px;
      left: 3px;
      transition: transform 0.2s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle-track.active .toggle-thumb {
      transform: translateX(20px);
    }
    .skipped-today-notice {
      background: var(--warning);
      color: #5a4e1a;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      text-align: center;
      font-weight: 500;
      font-size: 15px;
    }
    .chart-bar-skipped {
      background: repeating-linear-gradient(
        -45deg,
        var(--warning),
        var(--warning) 3px,
        #f0d97a 3px,
        #f0d97a 6px
      );
      border-radius: 4px 4px 0 0;
      opacity: 0.7;
    }
    
    /* Inline form row */
    .form-row {
      display: flex;
      gap: 12px;
    }
    .form-row > * { flex: 1; }
    
    /* Delete/Edit buttons in list */
    .delete-btn, .edit-btn {
      background: none;
      border: none;
      padding: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    .delete-btn { color: var(--danger); }
    .edit-btn { color: var(--primary); }
    
    /* Chart container */
    .chart-container {
      position: relative;
      height: 250px;
      margin: 16px 0;
    }
    
    /* Simple chart */
    .simple-chart {
      position: relative;
      display: flex;
      gap: 4px;
      padding: 10px 0;
    }
    .chart-bar {
      background: var(--primary);
      border-radius: 4px 4px 0 0;
      position: relative;
      opacity: 0.8;
      transition: opacity 0.2s;
    }
    .chart-bar:hover {
      opacity: 1;
    }
    .chart-label {
      font-size: 10px;
      color: var(--text-light);
      text-align: center;
      margin-top: 4px;
    }
    .chart-wrapper {
      margin-bottom: 20px;
    }
    .chart-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text);
    }
    
    /* Period selector */
    .period-selector {
      display: flex;
      background: var(--bg);
      border-radius: 8px;
      padding: 4px;
      margin-bottom: 16px;
    }
    .period-btn {
      flex: 1;
      padding: 8px;
      border: none;
      background: none;
      border-radius: 6px;
      font-size: 14px;
      color: var(--text-light);
      cursor: pointer;
    }
    .period-btn.active {
      background: var(--card);
      color: var(--text);
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <header>
    <h1 id="page-title">VitaTrack</h1>
  </header>

  <main>
    <!-- HOME PAGE -->
    <div id="home" class="page active">
      <div id="skip-day-area"></div>

      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="today-calories">0</div>
          <div class="stat-label">Calories Today</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="today-protein">0g</div>
          <div class="stat-label">Protein Today</div>
        </div>
      </div>
      
      <div id="today-meals-card" class="card">
        <h2>Today's Meals</h2>
        <div id="today-meals">
          <p class="empty">No meals logged today</p>
        </div>
      </div>
    </div>

    <!-- TRENDS PAGE -->
    <div id="trends" class="page">
      <div class="period-selector">
        <button class="period-btn active" onclick="setTrendPeriod(7)">7 Days</button>
        <button class="period-btn" onclick="setTrendPeriod(14)">14 Days</button>
        <button class="period-btn" onclick="setTrendPeriod(30)">30 Days</button>
      </div>

      <div class="card">
        <div class="chart-wrapper">
          <div class="chart-title">Daily Calories <span style="font-weight: normal; color: var(--text-light); font-size: 12px;" id="cal-max"></span></div>
          <div id="calories-chart" class="simple-chart"></div>
        </div>
        
        <div class="chart-wrapper">
          <div class="chart-title">Daily Protein (g) <span style="font-weight: normal; color: var(--text-light); font-size: 12px;" id="protein-max"></span></div>
          <div id="protein-chart" class="simple-chart"></div>
        </div>
        
        <div class="chart-wrapper">
          <div class="chart-title">Daily Carbs (g) <span style="font-weight: normal; color: var(--text-light); font-size: 12px;" id="carbs-max"></span></div>
          <div id="carbs-chart" class="simple-chart"></div>
        </div>
        
        <div class="chart-wrapper">
          <div class="chart-title">Daily Fat (g) <span style="font-weight: normal; color: var(--text-light); font-size: 12px;" id="fat-max"></span></div>
          <div id="fat-chart" class="simple-chart"></div>
        </div>
      </div>
      
      <div class="card">
        <h2>Summary</h2>
        <div id="trend-summary"></div>
      </div>
    </div>

    <!-- FOOD PAGE -->
    <div id="food" class="page">
      <div class="card" style="padding: 12px 16px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <label style="margin:0;white-space:nowrap;font-weight:500;font-size:14px;">Log for:</label>
          <div class="period-selector" style="margin:0;flex:1;">
            <button class="period-btn active" id="date-today-btn" onclick="setMealDate('today')">Today</button>
            <button class="period-btn" id="date-yesterday-btn" onclick="setMealDate('yesterday')">Yesterday</button>
            <button class="period-btn" id="date-other-btn" onclick="document.getElementById('meal-date-picker').showPicker()">Other…</button>
          </div>
          <input type="date" id="meal-date-picker" style="position:absolute;opacity:0;width:0;height:0;pointer-events:none;" onchange="setMealDate('custom')">
        </div>
        <div id="meal-date-display" style="display:none;text-align:center;margin-top:8px;font-size:13px;color:var(--primary);font-weight:500;"></div>
      </div>

      <div class="card">
        <h2>Log Meal</h2>
        
        <label>Search Ingredients</label>
        <input type="text" id="ingredient-search" placeholder="Type to search..." oninput="searchIngredients()">
        <div id="search-results" class="search-results" style="display:none;"></div>
        
        <div id="selected-ingredients" class="chips"></div>
        
        <div id="meal-macros" class="macros-total" style="display:none;">
          <div class="macros-row"><span>Calories</span><span id="meal-cal">0</span></div>
          <div class="macros-row"><span>Protein</span><span id="meal-protein">0g</span></div>
          <div class="macros-row"><span>Carbs</span><span id="meal-carbs">0g</span></div>
          <div class="macros-row"><span>Fat</span><span id="meal-fat">0g</span></div>
        </div>
        
        <button class="btn btn-primary" onclick="saveMeal()">Save Meal</button>
        <button class="btn btn-secondary" onclick="openNewIngredientModal()">+ New Ingredient</button>
      </div>

      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;" onclick="toggleQuickAdd()">
          <h2 style="margin-bottom:0;">Quick Add Macros</h2>
          <span id="quick-add-chevron" style="font-size:18px;color:var(--text-light);transition:transform 0.2s;">▸</span>
        </div>
        <div id="quick-add-body" style="display:none;margin-top:12px;">
          <p style="font-size:13px;color:var(--text-light);margin-bottom:12px;">Log calories and macros directly — no ingredients needed.</p>
          <label>Label (optional)</label>
          <input type="text" id="quick-label" placeholder="e.g., Restaurant dinner, Snack…">
          <div class="form-row">
            <div>
              <label>Calories *</label>
              <input type="number" id="quick-cal" inputmode="decimal" placeholder="0">
            </div>
            <div>
              <label>Protein (g)</label>
              <input type="number" id="quick-protein" inputmode="decimal" placeholder="0">
            </div>
          </div>
          <div class="form-row">
            <div>
              <label>Carbs (g)</label>
              <input type="number" id="quick-carbs" inputmode="decimal" placeholder="0">
            </div>
            <div>
              <label>Fat (g)</label>
              <input type="number" id="quick-fat" inputmode="decimal" placeholder="0">
            </div>
          </div>
          <button class="btn btn-primary" onclick="saveQuickAdd()">Log Macros</button>
        </div>
      </div>
      
      <div class="card">
        <h2>Recent Meals</h2>
        <div id="meal-history"></div>
      </div>
    </div>

    <!-- INGREDIENTS PAGE -->
    <div id="ingredients" class="page">
      <div class="card">
        <input type="text" id="repo-search" placeholder="Search your ingredients..." oninput="filterRepository()">
        <button class="btn btn-primary" onclick="openNewIngredientModal()">+ Add Ingredient</button>
      </div>
      
      <div class="card">
        <h2>Your Ingredients</h2>
        <div id="ingredient-list"></div>
      </div>
    </div>

    <!-- DATA PAGE -->
    <div id="data" class="page">
      <div class="card">
        <h2>Export Data</h2>
        <button class="btn btn-secondary" onclick="exportData('json')">Export as JSON</button>
        <button class="btn btn-secondary" onclick="exportData('csv')">Export Meals as CSV</button>
      </div>
      
      <div class="card">
        <h2>Import Data</h2>
        <input type="file" id="import-file" accept=".json" onchange="importData()">
      </div>
      
      <div class="card">
        <h2>Summary</h2>
        <div id="data-summary"></div>
      </div>
    </div>
  </main>

  <nav>
    <button class="active" onclick="showPage('home')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
      Home
    </button>
    <button onclick="showPage('trends')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>
      Trends
    </button>
    <button onclick="showPage('food')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
      Food
    </button>
    <button onclick="showPage('ingredients')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
      Ingredients
    </button>
    <button onclick="showPage('data')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
      Data
    </button>
  </nav>

  <!-- Edit Ingredient Modal -->
  <div id="ingredient-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="ingredient-modal-title">New Ingredient</h3>
        <button class="modal-close" onclick="closeIngredientModal()">&times;</button>
      </div>
      
      <label>Name *</label>
      <input type="text" id="new-ing-name" placeholder="e.g., Chicken Breast">
      
      <div class="form-row">
        <div>
          <label>Serving Size *</label>
          <input type="number" id="new-ing-serving" inputmode="decimal" placeholder="100">
        </div>
        <div>
          <label>Unit *</label>
          <select id="new-ing-unit">
            <option value="g">grams (g)</option>
            <option value="ml">milliliters (ml)</option>
            <option value="oz">ounces (oz)</option>
            <option value="cup">cup</option>
            <option value="tbsp">tablespoon</option>
            <option value="piece">piece</option>
          </select>
        </div>
      </div>
      
      <h2 style="margin: 16px 0 12px;">Nutrition per serving</h2>
      
      <div class="form-row">
        <div>
          <label>Calories *</label>
          <input type="number" id="new-ing-cal" inputmode="decimal" placeholder="0">
        </div>
        <div>
          <label>Protein (g) *</label>
          <input type="number" id="new-ing-protein" inputmode="decimal" placeholder="0">
        </div>
      </div>
      
      <div class="form-row">
        <div>
          <label>Carbs (g)</label>
          <input type="number" id="new-ing-carbs" inputmode="decimal" placeholder="0">
        </div>
        <div>
          <label>Fat (g)</label>
          <input type="number" id="new-ing-fat" inputmode="decimal" placeholder="0">
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="saveIngredient()">Save Ingredient</button>
      <button class="btn btn-danger" id="delete-ingredient-btn" style="display:none;" onclick="deleteIngredientFromModal()">Delete Ingredient</button>
    </div>
  </div>

  <!-- Edit Meal Modal -->
  <div id="meal-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Meal</h3>
        <button class="modal-close" onclick="closeMealModal()">&times;</button>
      </div>
      
      <div id="edit-meal-ingredients" class="chips"></div>
      
      <label>Search to add more ingredients</label>
      <input type="text" id="edit-meal-search" placeholder="Type to search..." oninput="searchIngredientsForEdit()">
      <div id="edit-search-results" class="search-results" style="display:none;"></div>
      
      <div id="edit-meal-macros" class="macros-total">
        <div class="macros-row"><span>Calories</span><span id="edit-meal-cal">0</span></div>
        <div class="macros-row"><span>Protein</span><span id="edit-meal-protein">0g</span></div>
        <div class="macros-row"><span>Carbs</span><span id="edit-meal-carbs">0g</span></div>
        <div class="macros-row"><span>Fat</span><span id="edit-meal-fat">0g</span></div>
      </div>
      
      <button class="btn btn-primary" onclick="saveEditedMeal()">Save Changes</button>
      <button class="btn btn-danger" onclick="deleteMealFromModal()">Delete Meal</button>
    </div>
  </div>

  <!-- Quantity Modal -->
  <div id="quantity-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="qty-ingredient-name">Ingredient</h3>
        <button class="modal-close" onclick="closeQuantityModal()">&times;</button>
      </div>
      
      <label>Quantity</label>
      <div class="form-row">
        <input type="number" id="qty-amount" inputmode="decimal" placeholder="1">
        <select id="qty-unit"></select>
      </div>
      
      <div id="qty-preview" class="macros-total">
        <div class="macros-row"><span>Calories</span><span id="qty-cal">0</span></div>
        <div class="macros-row"><span>Protein</span><span id="qty-protein">0g</span></div>
        <div class="macros-row"><span>Carbs</span><span id="qty-carbs">0g</span></div>
        <div class="macros-row"><span>Fat</span><span id="qty-fat">0g</span></div>
      </div>
      
      <button class="btn btn-primary" onclick="confirmAddIngredient()">Add to Meal</button>
    </div>
  </div>

  <script>
    // ===== PWA SUPPORT =====
    let deferredPrompt = null;

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => {
            console.log('Service Worker registered:', reg.scope);
            // Check for updates periodically
            setInterval(() => reg.update(), 60 * 60 * 1000);
          })
          .catch(err => console.log('Service Worker registration failed:', err));
      });
    }

    // Capture install prompt
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallBanner();
    });

    function showInstallBanner() {
      const existing = document.getElementById('install-banner');
      if (existing) return;

      const banner = document.createElement('div');
      banner.id = 'install-banner';
      banner.innerHTML = `
        <div style="position:fixed;bottom:70px;left:12px;right:12px;background:var(--primary);color:white;padding:14px 16px;border-radius:12px;display:flex;align-items:center;justify-content:space-between;z-index:150;box-shadow:0 4px 12px rgba(0,0,0,0.2);">
          <div style="flex:1;">
            <div style="font-weight:600;font-size:15px;">Install VitaTrack</div>
            <div style="font-size:13px;opacity:0.9;">Add to home screen for quick access</div>
          </div>
          <button onclick="installPWA()" style="background:white;color:var(--primary);border:none;padding:10px 18px;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;margin-left:12px;">Install</button>
          <button onclick="dismissInstallBanner()" style="background:none;border:none;color:white;font-size:22px;cursor:pointer;padding:4px 8px;margin-left:4px;opacity:0.8;">&times;</button>
        </div>
      `;
      document.body.appendChild(banner);
    }

    function installPWA() {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choice) => {
        deferredPrompt = null;
        dismissInstallBanner();
      });
    }

    function dismissInstallBanner() {
      const banner = document.getElementById('install-banner');
      if (banner) banner.remove();
    }

    // Hide banner once installed
    window.addEventListener('appinstalled', () => {
      deferredPrompt = null;
      dismissInstallBanner();
      console.log('VitaTrack installed!');
    });

    // ===== DATA STORAGE =====
    const DB = {
      get(key) {
        const data = localStorage.getItem('vitatrack_' + key);
        return data ? JSON.parse(data) : null;
      },
      set(key, value) {
        localStorage.setItem('vitatrack_' + key, JSON.stringify(value));
      }
    };

    // Initialize default data
    function initData() {
      if (!DB.get('ingredients')) {
        DB.set('ingredients', [
          { id: 1, name: 'Chicken Breast', serving: 100, unit: 'g', cal: 165, protein: 31, carbs: 0, fat: 3.6 },
          { id: 2, name: 'White Rice (cooked)', serving: 100, unit: 'g', cal: 130, protein: 2.7, carbs: 28, fat: 0.3 },
          { id: 3, name: 'Egg', serving: 1, unit: 'piece', cal: 72, protein: 6, carbs: 0.4, fat: 5 },
          { id: 4, name: 'Banana', serving: 1, unit: 'piece', cal: 105, protein: 1.3, carbs: 27, fat: 0.4 },
          { id: 5, name: 'Olive Oil', serving: 1, unit: 'tbsp', cal: 119, protein: 0, carbs: 0, fat: 13.5 },
          { id: 6, name: 'Broccoli', serving: 100, unit: 'g', cal: 34, protein: 2.8, carbs: 7, fat: 0.4 },
          { id: 7, name: 'Salmon', serving: 100, unit: 'g', cal: 208, protein: 20, carbs: 0, fat: 13 },
          { id: 8, name: 'Oats', serving: 40, unit: 'g', cal: 150, protein: 5, carbs: 27, fat: 2.5 },
        ]);
      }
      if (!DB.get('meals')) DB.set('meals', []);
    }

    // ===== NAVIGATION =====
    let currentPage = 'home';
    
    function showPage(page) {
      currentPage = page;
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(page).classList.add('active');
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      event.target.closest('button').classList.add('active');
      
      const titles = { 
        home: 'VitaTrack', 
        trends: 'Trends',
        food: 'Log Food', 
        ingredients: 'Ingredients', 
        data: 'Data' 
      };
      document.getElementById('page-title').textContent = titles[page];
      
      refreshPage();
    }

    function refreshPage() {
      if (currentPage === 'home') refreshHome();
      else if (currentPage === 'trends') refreshTrends();
      else if (currentPage === 'food') refreshMeals();
      else if (currentPage === 'ingredients') refreshIngredients();
      else if (currentPage === 'data') refreshDataSummary();
    }

    // ===== SKIPPED DAYS =====
    function getSkippedDays() {
      return DB.get('skippedDays') || [];
    }

    function toDateStr(date) {
      const d = typeof date === 'string' ? new Date(date) : date;
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function isDaySkipped(dateStr) {
      return getSkippedDays().includes(dateStr);
    }

    function toggleSkipDay(dateStr) {
      let skipped = getSkippedDays();
      if (skipped.includes(dateStr)) {
        skipped = skipped.filter(d => d !== dateStr);
      } else {
        skipped.push(dateStr);
      }
      DB.set('skippedDays', skipped);
      refreshHome();
    }

    // ===== HOME PAGE =====
    function refreshHome() {
      const meals = DB.get('meals') || [];
      const today = new Date().toDateString();
      const todayStr = toDateStr(new Date());
      const skipped = isDaySkipped(todayStr);

      // Render skip-day area
      const skipArea = document.getElementById('skip-day-area');
      if (skipped) {
        skipArea.innerHTML = `
          <div class="skipped-today-notice">
            ☁️ Today is marked as unknown
          </div>
          <div class="skip-day-banner">
            <div class="skip-info">
              <div class="skip-label">Day off tracking</div>
              <div class="skip-sublabel">Tap to resume tracking today</div>
            </div>
            <div class="toggle-track active" onclick="toggleSkipDay('${todayStr}')">
              <div class="toggle-thumb"></div>
            </div>
          </div>
        `;
      } else {
        skipArea.innerHTML = `
          <div class="skip-day-banner">
            <div class="skip-info">
              <div class="skip-label">Mark today as unknown</div>
              <div class="skip-sublabel">Vacation, eating out, no idea on calories…</div>
            </div>
            <div class="toggle-track" onclick="toggleSkipDay('${todayStr}')">
              <div class="toggle-thumb"></div>
            </div>
          </div>
        `;
      }

      // Today's totals
      const todayMeals = meals.filter(m => new Date(m.date).toDateString() === today);
      let totalCal = 0, totalProtein = 0;
      todayMeals.forEach(m => {
        totalCal += m.totalCal || 0;
        totalProtein += m.totalProtein || 0;
      });
      
      const statsEl = document.querySelector('.stats');
      const mealsCardEl = document.getElementById('today-meals-card');

      if (skipped) {
        statsEl.style.opacity = '0.35';
        mealsCardEl.style.opacity = '0.35';
      } else {
        statsEl.style.opacity = '1';
        mealsCardEl.style.opacity = '1';
      }

      document.getElementById('today-calories').textContent = Math.round(totalCal);
      document.getElementById('today-protein').textContent = Math.round(totalProtein) + 'g';
      
      // Today's meals
      const mealsEl = document.getElementById('today-meals');
      if (todayMeals.length > 0) {
        mealsEl.innerHTML = todayMeals.map(m => {
          const time = new Date(m.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          const subtitle = m.quickAdd
            ? `<span style="color:var(--primary);font-size:11px;font-weight:600;">QUICK</span> ${m.ingredients[0].name}`
            : m.ingredients.map(i => i.name).join(', ');
          return `
            <div class="list-item">
              <div>
                <div class="list-item-title">${time}</div>
                <div class="list-item-subtitle">${subtitle}</div>
              </div>
              <div class="list-item-value">
                <div>${m.totalCal} cal</div>
                <div class="list-item-macro">${m.totalProtein}g protein</div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        mealsEl.innerHTML = skipped
          ? '<p class="empty">Day marked as unknown</p>'
          : '<p class="empty">No meals logged today</p>';
      }
    }

    // ===== TRENDS PAGE =====
    let trendPeriod = 7;

    function setTrendPeriod(days) {
      trendPeriod = days;
      document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      refreshTrends();
    }

    function refreshTrends() {
      const meals = DB.get('meals') || [];
      const skippedDays = getSkippedDays();
      
      // Get date range using local dates
      const endDate = new Date();
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - trendPeriod + 1);
      
      // Create daily data using local date strings
      const dailyData = {};
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = toDateStr(d);
        dailyData[dateStr] = { cal: 0, protein: 0, carbs: 0, fat: 0, skipped: skippedDays.includes(dateStr) };
      }
      
      // Aggregate meals by day using local dates
      meals.forEach(m => {
        const dateStr = toDateStr(new Date(m.date));
        
        if (dailyData[dateStr]) {
          dailyData[dateStr].cal += m.totalCal || 0;
          dailyData[dateStr].protein += m.totalProtein || 0;
          dailyData[dateStr].carbs += m.totalCarbs || 0;
          dailyData[dateStr].fat += m.totalFat || 0;
        }
      });
      
      // Render charts
      renderSimpleChart('calories-chart', dailyData, 'cal', 'cal');
      renderSimpleChart('protein-chart', dailyData, 'protein', 'g');
      renderSimpleChart('carbs-chart', dailyData, 'carbs', 'g');
      renderSimpleChart('fat-chart', dailyData, 'fat', 'g');
      
      // Calculate summary — exclude skipped days
      const values = Object.values(dailyData);
      const trackedDays = values.filter(d => !d.skipped);
      const skippedCount = values.filter(d => d.skipped).length;
      const daysWithData = trackedDays.filter(d => d.cal > 0).length;
      const avgCal = daysWithData > 0 ? trackedDays.reduce((sum, d) => sum + d.cal, 0) / daysWithData : 0;
      const avgProtein = daysWithData > 0 ? trackedDays.reduce((sum, d) => sum + d.protein, 0) / daysWithData : 0;
      const avgCarbs = daysWithData > 0 ? trackedDays.reduce((sum, d) => sum + d.carbs, 0) / daysWithData : 0;
      const avgFat = daysWithData > 0 ? trackedDays.reduce((sum, d) => sum + d.fat, 0) / daysWithData : 0;
      
      document.getElementById('trend-summary').innerHTML = `
        <div class="list-item">
          <span>Days Tracked</span>
          <strong>${daysWithData} / ${trendPeriod}</strong>
        </div>
        ${skippedCount > 0 ? `
        <div class="list-item">
          <span>Unknown Days</span>
          <strong style="color: #b8860b;">${skippedCount}</strong>
        </div>` : ''}
        <div class="list-item">
          <span>Avg Daily Calories</span>
          <strong>${Math.round(avgCal)}</strong>
        </div>
        <div class="list-item">
          <span>Avg Daily Protein</span>
          <strong>${Math.round(avgProtein)}g</strong>
        </div>
        <div class="list-item">
          <span>Avg Daily Carbs</span>
          <strong>${Math.round(avgCarbs)}g</strong>
        </div>
        <div class="list-item">
          <span>Avg Daily Fat</span>
          <strong>${Math.round(avgFat)}g</strong>
        </div>
      `;
    }

    function renderSimpleChart(elementId, dailyData, key, label) {
      const el = document.getElementById(elementId);
      const dates = Object.keys(dailyData).sort();
      const values = dates.map(d => dailyData[d][key]);
      const skippedFlags = dates.map(d => dailyData[d].skipped);
      const trackedValues = values.filter((v, i) => !skippedFlags[i]);
      const maxValue = trackedValues.length > 0 ? Math.max(...trackedValues) : 0;
      
      // Update max value display
      const maxElementId = elementId.replace('-chart', '-max');
      const maxEl = document.getElementById(maxElementId);
      if (maxEl) {
        maxEl.textContent = maxValue > 0 ? `(max: ${Math.round(maxValue)})` : '';
      }
      
      // Check if there's any data at all (including skipped)
      const hasAnyTracked = trackedValues.some(v => v > 0);
      const hasAnySkipped = skippedFlags.some(s => s);
      if (!hasAnyTracked && !hasAnySkipped) {
        el.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: var(--text-light);">No data for this period</div>';
        return;
      }
      
      el.innerHTML = dates.map((date, i) => {
        const value = values[i];
        const isSkipped = skippedFlags[i];
        const dateObj = new Date(date + 'T12:00:00');
        const dayLabel = dateObj.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
        
        if (isSkipped) {
          return `
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px;">
              <div style="width: 100%; height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                <div style="font-size: 16px; margin-bottom: 4px; color: #b8860b;" title="Unknown day">?</div>
                <div class="chart-bar-skipped" style="width: 80%; height: 40px;" title="Unknown day"></div>
              </div>
              <div class="chart-label" style="color: #b8860b;">${dayLabel}</div>
            </div>
          `;
        }
        
        const heightPx = maxValue > 0 ? Math.max((value / maxValue) * 180, value > 0 ? 3 : 0) : 0;
        
        return `
          <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px;">
            <div style="width: 100%; height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
              ${value > 0 ? `<div style="font-size: 11px; font-weight: 600; color: var(--text); margin-bottom: 4px;">${Math.round(value)}</div>` : ''}
              <div class="chart-bar" style="width: 80%; height: ${heightPx}px; min-height: ${value > 0 ? '3px' : '0'};" title="${Math.round(value)} ${label}"></div>
            </div>
            <div class="chart-label">${dayLabel}</div>
          </div>
        `;
      }).join('');
    }

    // ===== MEAL DATE PICKER =====
    let mealDateMode = 'today'; // 'today', 'yesterday', 'custom'

    function setMealDate(mode) {
      mealDateMode = mode;
      const picker = document.getElementById('meal-date-picker');
      const display = document.getElementById('meal-date-display');

      document.getElementById('date-today-btn').classList.remove('active');
      document.getElementById('date-yesterday-btn').classList.remove('active');
      document.getElementById('date-other-btn').classList.remove('active');

      if (mode === 'today') {
        document.getElementById('date-today-btn').classList.add('active');
        display.style.display = 'none';
      } else if (mode === 'yesterday') {
        document.getElementById('date-yesterday-btn').classList.add('active');
        display.style.display = 'none';
      } else if (mode === 'custom') {
        document.getElementById('date-other-btn').classList.add('active');
        const val = picker.value;
        if (val) {
          const parts = val.split('-');
          const d = new Date(parts[0], parts[1] - 1, parts[2]);
          display.textContent = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
          display.style.display = 'block';
        }
      }
    }

    function getMealDate() {
      const now = new Date();
      if (mealDateMode === 'today') {
        return now;
      } else if (mealDateMode === 'yesterday') {
        const d = new Date(now);
        d.setDate(d.getDate() - 1);
        // Set to noon so it's clearly that day
        d.setHours(12, 0, 0, 0);
        return d;
      } else {
        const val = document.getElementById('meal-date-picker').value;
        if (val) {
          const parts = val.split('-');
          const d = new Date(parts[0], parts[1] - 1, parts[2], 12, 0, 0);
          return d;
        }
        return now;
      }
    }

    // ===== FOOD LOGGING =====
    let selectedIngredients = [];
    let pendingIngredient = null;
    let newMealEditIndex = null; // track re-editing an ingredient in new meal

    function editSelectedIngredient(idx) {
      const ing = selectedIngredients[idx];
      const ingredients = DB.get('ingredients') || [];
      const baseIng = ingredients.find(i => i.id === ing.id);
      
      // For quick-add entries there's no base ingredient
      if (!baseIng) {
        alert('This entry can only be removed, not edited');
        return;
      }
      
      newMealEditIndex = idx;
      pendingIngredient = baseIng;
      
      document.getElementById('qty-ingredient-name').textContent = ing.name;
      document.getElementById('qty-amount').value = ing.amount;
      document.getElementById('qty-unit').innerHTML = `<option value="${ing.unit}">${ing.unit}</option>`;
      updateQuantityPreview();
      
      document.getElementById('quantity-modal').classList.add('active');
    }

    function searchIngredients() {
      const query = document.getElementById('ingredient-search').value.toLowerCase().trim();
      const resultsEl = document.getElementById('search-results');
      
      if (query.length < 1) {
        resultsEl.style.display = 'none';
        return;
      }
      
      const ingredients = DB.get('ingredients') || [];
      const matches = ingredients.filter(i => 
        i.name.toLowerCase().includes(query)
      ).slice(0, 5);
      
      if (matches.length === 0) {
        resultsEl.innerHTML = '<div class="search-result">No matches found</div>';
      } else {
        resultsEl.innerHTML = matches.map(i => `
          <div class="search-result" onclick="selectIngredient(${i.id})">
            <div class="search-result-name">${i.name}</div>
            <div class="search-result-macros">${i.cal} cal • ${i.protein}g protein per ${i.serving}${i.unit}</div>
          </div>
        `).join('');
      }
      resultsEl.style.display = 'block';
    }

    function selectIngredient(id) {
      const ingredients = DB.get('ingredients') || [];
      const ing = ingredients.find(i => i.id === id);
      if (!ing) return;
      
      pendingIngredient = ing;
      document.getElementById('qty-ingredient-name').textContent = ing.name;
      document.getElementById('qty-amount').value = ing.serving;
      document.getElementById('qty-unit').innerHTML = `<option value="${ing.unit}">${ing.unit}</option>`;
      updateQuantityPreview();
      
      document.getElementById('quantity-modal').classList.add('active');
      document.getElementById('search-results').style.display = 'none';
      document.getElementById('ingredient-search').value = '';
    }

    function updateQuantityPreview() {
      if (!pendingIngredient) return;
      const amount = parseFloat(document.getElementById('qty-amount').value) || 0;
      const ratio = amount / pendingIngredient.serving;
      
      document.getElementById('qty-cal').textContent = Math.round(pendingIngredient.cal * ratio);
      document.getElementById('qty-protein').textContent = Math.round(pendingIngredient.protein * ratio) + 'g';
      document.getElementById('qty-carbs').textContent = Math.round((pendingIngredient.carbs || 0) * ratio) + 'g';
      document.getElementById('qty-fat').textContent = Math.round((pendingIngredient.fat || 0) * ratio) + 'g';
    }

    document.getElementById('qty-amount').addEventListener('input', updateQuantityPreview);

    function closeQuantityModal() {
      document.getElementById('quantity-modal').classList.remove('active');
      pendingIngredient = null;
      editingMealIngredientIndex = null;
      newMealEditIndex = null;
    }

    function confirmAddIngredient() {
      if (!pendingIngredient) return;
      const amount = parseFloat(document.getElementById('qty-amount').value) || 0;
      const ratio = amount / pendingIngredient.serving;
      
      const ingredientData = {
        id: pendingIngredient.id,
        name: pendingIngredient.name,
        amount,
        unit: pendingIngredient.unit,
        cal: Math.round(pendingIngredient.cal * ratio),
        protein: Math.round(pendingIngredient.protein * ratio),
        carbs: Math.round((pendingIngredient.carbs || 0) * ratio),
        fat: Math.round((pendingIngredient.fat || 0) * ratio)
      };
      
      // Check if we're editing an existing meal ingredient (edit modal)
      if (editingMealIngredientIndex !== null) {
        editingMealIngredients[editingMealIngredientIndex] = ingredientData;
        editingMealIngredientIndex = null;
        closeQuantityModal();
        updateEditMealDisplay();
      } else if (newMealEditIndex !== null) {
        // Re-editing an ingredient in the new meal
        selectedIngredients[newMealEditIndex] = ingredientData;
        newMealEditIndex = null;
        closeQuantityModal();
        updateSelectedIngredients();
      } else {
        // Adding to a new meal
        selectedIngredients.push(ingredientData);
        closeQuantityModal();
        updateSelectedIngredients();
      }
    }

    function updateSelectedIngredients() {
      const el = document.getElementById('selected-ingredients');
      el.innerHTML = selectedIngredients.map((ing, idx) => `
        <div class="chip" onclick="editSelectedIngredient(${idx})" style="cursor: pointer;">
          ${ing.name} (${ing.amount}${ing.unit})
          <button class="chip-remove" onclick="event.stopPropagation(); removeIngredient(${idx})">×</button>
        </div>
      `).join('');
      
      // Update totals
      const macrosEl = document.getElementById('meal-macros');
      if (selectedIngredients.length > 0) {
        let totalCal = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;
        selectedIngredients.forEach(i => {
          totalCal += i.cal;
          totalProtein += i.protein;
          totalCarbs += i.carbs;
          totalFat += i.fat;
        });
        document.getElementById('meal-cal').textContent = totalCal;
        document.getElementById('meal-protein').textContent = totalProtein + 'g';
        document.getElementById('meal-carbs').textContent = totalCarbs + 'g';
        document.getElementById('meal-fat').textContent = totalFat + 'g';
        macrosEl.style.display = 'block';
      } else {
        macrosEl.style.display = 'none';
      }
    }

    function removeIngredient(idx) {
      selectedIngredients.splice(idx, 1);
      updateSelectedIngredients();
    }

    function saveMeal() {
      if (selectedIngredients.length === 0) {
        alert('Please add at least one ingredient');
        return;
      }
      
      let totalCal = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;
      selectedIngredients.forEach(i => {
        totalCal += i.cal;
        totalProtein += i.protein;
        totalCarbs += i.carbs;
        totalFat += i.fat;
      });
      
      const meals = DB.get('meals') || [];
      meals.push({
        id: Date.now(),
        date: getMealDate().toISOString(),
        ingredients: selectedIngredients,
        totalCal,
        totalProtein,
        totalCarbs,
        totalFat
      });
      DB.set('meals', meals);
      
      selectedIngredients = [];
      updateSelectedIngredients();
      refreshMeals();
      refreshHome();
      if (currentPage === 'trends') refreshTrends();
      const savedDate = getMealDate();
      const isToday = savedDate.toDateString() === new Date().toDateString();
      alert(isToday ? 'Meal saved!' : 'Meal saved for ' + savedDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) + '!');
    }

    // ===== QUICK ADD MACROS =====
    function toggleQuickAdd() {
      const body = document.getElementById('quick-add-body');
      const chevron = document.getElementById('quick-add-chevron');
      if (body.style.display === 'none') {
        body.style.display = 'block';
        chevron.style.transform = 'rotate(90deg)';
      } else {
        body.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
      }
    }

    function saveQuickAdd() {
      const cal = parseFloat(document.getElementById('quick-cal').value) || 0;
      const protein = parseFloat(document.getElementById('quick-protein').value) || 0;
      const carbs = parseFloat(document.getElementById('quick-carbs').value) || 0;
      const fat = parseFloat(document.getElementById('quick-fat').value) || 0;
      const label = document.getElementById('quick-label').value.trim() || 'Quick add';

      if (cal === 0 && protein === 0 && carbs === 0 && fat === 0) {
        alert('Please enter at least one value');
        return;
      }

      const meals = DB.get('meals') || [];
      meals.push({
        id: Date.now(),
        date: getMealDate().toISOString(),
        quickAdd: true,
        ingredients: [{ name: label, amount: 1, unit: 'entry', cal: Math.round(cal), protein: Math.round(protein), carbs: Math.round(carbs), fat: Math.round(fat) }],
        totalCal: Math.round(cal),
        totalProtein: Math.round(protein),
        totalCarbs: Math.round(carbs),
        totalFat: Math.round(fat)
      });
      DB.set('meals', meals);

      // Clear form
      document.getElementById('quick-label').value = '';
      document.getElementById('quick-cal').value = '';
      document.getElementById('quick-protein').value = '';
      document.getElementById('quick-carbs').value = '';
      document.getElementById('quick-fat').value = '';

      refreshMeals();
      refreshHome();
      if (currentPage === 'trends') refreshTrends();
      const savedDate = getMealDate();
      const isToday = savedDate.toDateString() === new Date().toDateString();
      alert(isToday ? 'Macros logged!' : 'Macros logged for ' + savedDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) + '!');
    }

    function refreshMeals() {
      const meals = DB.get('meals') || [];
      const el = document.getElementById('meal-history');
      
      if (meals.length === 0) {
        el.innerHTML = '<p class="empty">No meals logged yet</p>';
        return;
      }
      
      const sorted = [...meals].reverse().slice(0, 10);
      el.innerHTML = sorted.map(m => {
        const date = new Date(m.date).toLocaleDateString();
        const time = new Date(m.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const subtitle = m.quickAdd
          ? `<span style="color:var(--primary);font-size:11px;font-weight:600;">QUICK</span> ${m.ingredients[0].name}`
          : m.ingredients.map(i => i.name).join(', ');
        return `
          <div class="list-item">
            <div>
              <div class="list-item-title">${date} at ${time}</div>
              <div class="list-item-subtitle">${subtitle}</div>
            </div>
            <div class="list-item-actions">
              <div class="list-item-value">
                <div>${m.totalCal} cal</div>
              </div>
              <button class="edit-btn" onclick="editMeal(${m.id})">✎</button>
              <button class="delete-btn" onclick="deleteMeal(${m.id})">✕</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function deleteMeal(id) {
      if (!confirm('Delete this meal?')) return;
      let meals = DB.get('meals') || [];
      meals = meals.filter(m => m.id !== id);
      DB.set('meals', meals);
      refreshMeals();
      refreshHome();
      if (currentPage === 'trends') refreshTrends();
    }

    // ===== EDIT MEAL =====
    let editingMealId = null;
    let editingMealIngredients = [];

    function editMeal(id) {
      const meals = DB.get('meals') || [];
      const meal = meals.find(m => m.id === id);
      if (!meal) return;
      
      editingMealId = id;
      editingMealIngredients = [...meal.ingredients];
      
      updateEditMealDisplay();
      document.getElementById('meal-modal').classList.add('active');
    }

    function updateEditMealDisplay() {
      const el = document.getElementById('edit-meal-ingredients');
      el.innerHTML = editingMealIngredients.map((ing, idx) => `
        <div class="chip" onclick="editMealIngredientAmount(${idx})" style="cursor: pointer;">
          ${ing.name} (${ing.amount}${ing.unit})
          <button class="chip-remove" onclick="event.stopPropagation(); removeEditIngredient(${idx})">×</button>
        </div>
      `).join('');
      
      // Update totals
      let totalCal = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;
      editingMealIngredients.forEach(i => {
        totalCal += i.cal;
        totalProtein += i.protein;
        totalCarbs += i.carbs;
        totalFat += i.fat;
      });
      
      document.getElementById('edit-meal-cal').textContent = totalCal;
      document.getElementById('edit-meal-protein').textContent = totalProtein + 'g';
      document.getElementById('edit-meal-carbs').textContent = totalCarbs + 'g';
      document.getElementById('edit-meal-fat').textContent = totalFat + 'g';
    }

    function removeEditIngredient(idx) {
      editingMealIngredients.splice(idx, 1);
      updateEditMealDisplay();
    }

    let editingMealIngredientIndex = null;

    function editMealIngredientAmount(idx) {
      const ing = editingMealIngredients[idx];
      const ingredients = DB.get('ingredients') || [];
      const baseIng = ingredients.find(i => i.id === ing.id);
      
      if (!baseIng) {
        alert('Base ingredient not found');
        return;
      }
      
      editingMealIngredientIndex = idx;
      pendingIngredient = baseIng;
      
      document.getElementById('qty-ingredient-name').textContent = ing.name;
      document.getElementById('qty-amount').value = ing.amount;
      document.getElementById('qty-unit').innerHTML = `<option value="${ing.unit}">${ing.unit}</option>`;
      updateQuantityPreview();
      
      document.getElementById('quantity-modal').classList.add('active');
    }

    function searchIngredientsForEdit() {
      const query = document.getElementById('edit-meal-search').value.toLowerCase().trim();
      const resultsEl = document.getElementById('edit-search-results');
      
      if (query.length < 1) {
        resultsEl.style.display = 'none';
        return;
      }
      
      const ingredients = DB.get('ingredients') || [];
      const matches = ingredients.filter(i => 
        i.name.toLowerCase().includes(query)
      ).slice(0, 5);
      
      if (matches.length === 0) {
        resultsEl.innerHTML = '<div class="search-result">No matches found</div>';
      } else {
        resultsEl.innerHTML = matches.map(i => `
          <div class="search-result" onclick="addToEditMeal(${i.id})">
            <div class="search-result-name">${i.name}</div>
            <div class="search-result-macros">${i.cal} cal • ${i.protein}g protein per ${i.serving}${i.unit}</div>
          </div>
        `).join('');
      }
      resultsEl.style.display = 'block';
    }

    function addToEditMeal(id) {
      const ingredients = DB.get('ingredients') || [];
      const ing = ingredients.find(i => i.id === id);
      if (!ing) return;
      
      // Use the quantity modal to set the amount
      pendingIngredient = ing;
      editingMealIngredientIndex = editingMealIngredients.length; // Will add at the end
      
      // Pre-add a placeholder
      editingMealIngredients.push({
        id: ing.id,
        name: ing.name,
        amount: ing.serving,
        unit: ing.unit,
        cal: ing.cal,
        protein: ing.protein,
        carbs: ing.carbs || 0,
        fat: ing.fat || 0
      });
      
      document.getElementById('qty-ingredient-name').textContent = ing.name;
      document.getElementById('qty-amount').value = ing.serving;
      document.getElementById('qty-unit').innerHTML = `<option value="${ing.unit}">${ing.unit}</option>`;
      updateQuantityPreview();
      
      document.getElementById('edit-search-results').style.display = 'none';
      document.getElementById('edit-meal-search').value = '';
      document.getElementById('quantity-modal').classList.add('active');
    }

    function saveEditedMeal() {
      if (editingMealIngredients.length === 0) {
        alert('Meal must have at least one ingredient');
        return;
      }
      
      let totalCal = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;
      editingMealIngredients.forEach(i => {
        totalCal += i.cal;
        totalProtein += i.protein;
        totalCarbs += i.carbs;
        totalFat += i.fat;
      });
      
      let meals = DB.get('meals') || [];
      const mealIndex = meals.findIndex(m => m.id === editingMealId);
      if (mealIndex !== -1) {
        meals[mealIndex].ingredients = editingMealIngredients;
        meals[mealIndex].totalCal = totalCal;
        meals[mealIndex].totalProtein = totalProtein;
        meals[mealIndex].totalCarbs = totalCarbs;
        meals[mealIndex].totalFat = totalFat;
        DB.set('meals', meals);
      }
      
      closeMealModal();
      refreshMeals();
      refreshHome();
      if (currentPage === 'trends') refreshTrends();
      alert('Meal updated!');
    }

    function deleteMealFromModal() {
      if (!confirm('Delete this meal?')) return;
      let meals = DB.get('meals') || [];
      meals = meals.filter(m => m.id !== editingMealId);
      DB.set('meals', meals);
      closeMealModal();
      refreshMeals();
      refreshHome();
      if (currentPage === 'trends') refreshTrends();
    }

    function closeMealModal() {
      document.getElementById('meal-modal').classList.remove('active');
      document.getElementById('edit-meal-search').value = '';
      document.getElementById('edit-search-results').style.display = 'none';
      editingMealId = null;
      editingMealIngredients = [];
    }

    // ===== INGREDIENTS =====
    let editingIngredientId = null;

    function openNewIngredientModal() {
      editingIngredientId = null;
      document.getElementById('ingredient-modal-title').textContent = 'New Ingredient';
      document.getElementById('delete-ingredient-btn').style.display = 'none';
      clearIngredientForm();
      document.getElementById('ingredient-modal').classList.add('active');
    }

    function editIngredient(id) {
      const ingredients = DB.get('ingredients') || [];
      const ing = ingredients.find(i => i.id === id);
      if (!ing) return;
      
      editingIngredientId = id;
      document.getElementById('ingredient-modal-title').textContent = 'Edit Ingredient';
      document.getElementById('delete-ingredient-btn').style.display = 'block';
      
      document.getElementById('new-ing-name').value = ing.name;
      document.getElementById('new-ing-serving').value = ing.serving;
      document.getElementById('new-ing-unit').value = ing.unit;
      document.getElementById('new-ing-cal').value = ing.cal;
      document.getElementById('new-ing-protein').value = ing.protein;
      document.getElementById('new-ing-carbs').value = ing.carbs || 0;
      document.getElementById('new-ing-fat').value = ing.fat || 0;
      
      document.getElementById('ingredient-modal').classList.add('active');
    }

    function clearIngredientForm() {
      document.getElementById('new-ing-name').value = '';
      document.getElementById('new-ing-serving').value = '';
      document.getElementById('new-ing-unit').value = 'g';
      document.getElementById('new-ing-cal').value = '';
      document.getElementById('new-ing-protein').value = '';
      document.getElementById('new-ing-carbs').value = '';
      document.getElementById('new-ing-fat').value = '';
    }

    function closeIngredientModal() {
      document.getElementById('ingredient-modal').classList.remove('active');
      clearIngredientForm();
      editingIngredientId = null;
    }

    function saveIngredient() {
      const name = document.getElementById('new-ing-name').value.trim();
      const serving = parseFloat(document.getElementById('new-ing-serving').value);
      const unit = document.getElementById('new-ing-unit').value;
      const cal = parseFloat(document.getElementById('new-ing-cal').value) || 0;
      const protein = parseFloat(document.getElementById('new-ing-protein').value) || 0;
      const carbs = parseFloat(document.getElementById('new-ing-carbs').value) || 0;
      const fat = parseFloat(document.getElementById('new-ing-fat').value) || 0;
      
      if (!name || !serving) {
        alert('Please fill in name and serving size');
        return;
      }
      
      let ingredients = DB.get('ingredients') || [];
      
      if (editingIngredientId) {
        // Edit existing
        const index = ingredients.findIndex(i => i.id === editingIngredientId);
        if (index !== -1) {
          ingredients[index] = {
            ...ingredients[index],
            name,
            serving,
            unit,
            cal,
            protein,
            carbs,
            fat
          };
        }
      } else {
        // Add new
        ingredients.push({
          id: Date.now(),
          name,
          serving,
          unit,
          cal,
          protein,
          carbs,
          fat
        });
      }
      
      DB.set('ingredients', ingredients);
      closeIngredientModal();
      refreshIngredients();
      alert(editingIngredientId ? 'Ingredient updated!' : 'Ingredient added!');
    }

    function deleteIngredientFromModal() {
      if (!editingIngredientId) return;
      if (!confirm('Delete this ingredient?')) return;
      
      let ingredients = DB.get('ingredients') || [];
      ingredients = ingredients.filter(i => i.id !== editingIngredientId);
      DB.set('ingredients', ingredients);
      
      closeIngredientModal();
      refreshIngredients();
    }

    function refreshIngredients() {
      filterRepository();
    }

    function filterRepository() {
      const query = document.getElementById('repo-search').value.toLowerCase().trim();
      const ingredients = DB.get('ingredients') || [];
      
      let filtered = ingredients;
      if (query) {
        filtered = ingredients.filter(i => 
          i.name.toLowerCase().includes(query)
        );
      }
      
      const el = document.getElementById('ingredient-list');
      if (filtered.length === 0) {
        el.innerHTML = '<p class="empty">No ingredients found</p>';
        return;
      }
      
      el.innerHTML = filtered.map(i => `
        <div class="list-item">
          <div>
            <div class="list-item-title">${i.name}</div>
            <div class="list-item-subtitle">${i.cal} cal • ${i.protein}g protein per ${i.serving}${i.unit}</div>
          </div>
          <div class="list-item-actions">
            <button class="edit-btn" onclick="editIngredient(${i.id})">✎</button>
            <button class="delete-btn" onclick="deleteIngredient(${i.id})">✕</button>
          </div>
        </div>
      `).join('');
    }

    function deleteIngredient(id) {
      if (!confirm('Delete this ingredient?')) return;
      let ingredients = DB.get('ingredients') || [];
      ingredients = ingredients.filter(i => i.id !== id);
      DB.set('ingredients', ingredients);
      refreshIngredients();
    }

    // ===== DATA EXPORT/IMPORT =====
    function refreshDataSummary() {
      const meals = DB.get('meals') || [];
      const ingredients = DB.get('ingredients') || [];
      const skippedDays = getSkippedDays();
      
      document.getElementById('data-summary').innerHTML = `
        <div class="list-item">
          <span>Total Meals</span>
          <strong>${meals.length}</strong>
        </div>
        <div class="list-item">
          <span>Ingredients in Repository</span>
          <strong>${ingredients.length}</strong>
        </div>
        <div class="list-item">
          <span>Unknown Days</span>
          <strong style="${skippedDays.length > 0 ? 'color: #b8860b;' : ''}">${skippedDays.length}</strong>
        </div>
      `;
    }

    function exportData(format) {
      const data = {
        version: 1,
        exportDate: new Date().toISOString(),
        meals: DB.get('meals') || [],
        ingredients: DB.get('ingredients') || [],
        skippedDays: DB.get('skippedDays') || []
      };
      
      let content, filename, type;
      
      if (format === 'json') {
        content = JSON.stringify(data, null, 2);
        filename = 'vitatrack_export.json';
        type = 'application/json';
      } else if (format === 'csv') {
        const meals = data.meals;
        const headers = ['Date', 'Time', 'Ingredients', 'Calories', 'Protein', 'Carbs', 'Fat'];
        const rows = meals.map(m => {
          const d = new Date(m.date);
          return [
            d.toLocaleDateString(),
            d.toLocaleTimeString(),
            '"' + m.ingredients.map(i => i.name).join('; ') + '"',
            m.totalCal,
            m.totalProtein,
            m.totalCarbs,
            m.totalFat
          ].join(',');
        });
        content = [headers.join(','), ...rows].join('\n');
        filename = 'vitatrack_meals.csv';
        type = 'text/csv';
      }
      
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData() {
      const file = document.getElementById('import-file').files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.version && data.meals && data.ingredients) {
            if (confirm('This will replace all your current data. Continue?')) {
              DB.set('meals', data.meals);
              DB.set('ingredients', data.ingredients);
              if (data.skippedDays) DB.set('skippedDays', data.skippedDays);
              refreshPage();
              alert('Data imported successfully!');
            }
          } else {
            alert('Invalid file format');
          }
        } catch (err) {
          alert('Error reading file: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    // ===== INIT =====
    initData();
    // Set date picker max to today
    document.getElementById('meal-date-picker').max = toDateStr(new Date());
    refreshHome();
  </script>
</body>
</html>
